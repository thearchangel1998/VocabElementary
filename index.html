<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Flashcards & Game</title>
    <!-- S·ª≠ d·ª•ng Google Fonts cho font ch·ªØ ƒë·∫πp h∆°n -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Th∆∞ vi·ªán icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #f0f4f8;
            --card-width: 280px;
            --card-height: 200px;
            --text-color: #2d3748;
            
            /* Housing Colors */
            --housing-color: #4299e1; /* Blue */
            --housing-gradient: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            
            /* Places Colors */
            --places-color: #ed8936;  /* Orange */
            --places-gradient: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            
            /* Family Home Colors */
            --family-color: #48bb78;  /* Green */
            --family-gradient: linear-gradient(135deg, #48bb78 0%, #38a169 100%);

            --card-bg: #ffffff;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            
            /* Game Specific */
            --game-cover-bg: #2d3748;
            --game-card-size: 140px; /* Smaller cards for game */
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            user-select: none; /* Prevent text selection during game */
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--text-color);
            margin: 0 0 10px 0;
            font-weight: 800;
        }

        .mode-switch {
            display: flex;
            background: #e2e8f0;
            padding: 5px;
            border-radius: 30px;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }

        .mode-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 700;
            background: transparent;
            color: #718096;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background-color: white;
            color: #2d3748;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            transition: opacity 0.3s;
        }

        .filter-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            background-color: white;
            color: #718096;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background-color: #2d3748;
            color: white;
        }
        
        .filter-btn:hover:not(.active) {
            background-color: #e2e8f0;
        }

        /* Container Layouts */
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            justify-content: center;
            max-width: 1200px;
            padding-bottom: 40px;
            width: 100%;
        }

        /* --- FLASHCARD STYLES (Existing) --- */
        .card-wrapper {
            background-color: transparent;
            width: var(--card-width);
            height: var(--card-height);
            perspective: 1000px;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
            transform-style: preserve-3d;
            cursor: pointer;
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .card-wrapper.flipped .card-inner {
            transform: rotateY(180deg);
        }

        /* Shake animation for wrong match */
        @keyframes shake {
            0%, 100% { transform: translateX(0) rotateY(180deg); }
            20% { transform: translateX(-10px) rotateY(180deg); }
            40% { transform: translateX(10px) rotateY(180deg); }
            60% { transform: translateX(-10px) rotateY(180deg); }
            80% { transform: translateX(10px) rotateY(180deg); }
        }

        .card-wrapper.wrong .card-inner {
            animation: shake 0.5s;
            border: 2px solid #e53e3e;
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            box-sizing: border-box;
            background-color: var(--card-bg);
        }

        .card-front {
            border: 2px solid transparent;
            transition: border-color 0.3s;
        }

        /* Colors by Type */
        .type-housing .card-front { border-bottom: 6px solid var(--housing-color); }
        .type-place .card-front { border-bottom: 6px solid var(--places-color); }
        .type-family .card-front { border-bottom: 6px solid var(--family-color); }

        .type-housing .card-tag { background: var(--housing-gradient); }
        .type-place .card-tag { background: var(--places-gradient); }
        .type-family .card-tag { background: var(--family-gradient); }

        .type-housing .card-back { background: var(--housing-gradient); }
        .type-place .card-back { background: var(--places-gradient); }
        .type-family .card-back { background: var(--family-gradient); }

        .card-word {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 15px;
            line-height: 1.3;
        }

        .card-tag {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
        }

        .audio-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #a0aec0;
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.2s;
            z-index: 10;
            padding: 5px;
        }
        .audio-btn:hover { color: #4a5568; transform: scale(1.1); }

        .card-back {
            transform: rotateY(180deg);
            color: white;
        }

        .card-icon {
            font-size: 3.5rem;
            margin-bottom: 10px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .card-meaning {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        /* --- GAME MODE STYLES --- */
        .game-info {
            display: none;
            text-align: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px 30px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            animation: slideDown 0.3s ease;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            align-items: center;
        }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .game-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #718096;
            text-transform: uppercase;
            font-weight: 700;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: #2d3748;
        }

        .game-btn {
            background-color: #2d3748;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .game-btn:hover { transform: scale(1.05); }

        /* Game Card Adjustments */
        .container.game-mode {
            gap: 15px;
            max-width: 800px;
        }

        .container.game-mode .card-wrapper {
            width: var(--game-card-size);
            height: var(--game-card-size);
        }

        .container.game-mode .card-word { font-size: 1rem; margin-bottom: 5px; }
        .container.game-mode .card-icon { font-size: 2.5rem; margin-bottom: 5px; }
        .container.game-mode .card-meaning { font-size: 0.9rem; }
        .container.game-mode .card-tag { display: none; } /* Hide tag in game to save space */
        .container.game-mode .audio-btn { display: none; } /* Hide audio in game */

        /* Game Card "Cover" (The back of the card when face down) */
        .game-cover {
            background: var(--game-cover-bg);
            background-image: radial-gradient(#4a5568 15%, transparent 16%), radial-gradient(#4a5568 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid white;
        }
        
        .game-cover i {
            font-size: 2.5rem;
            color: rgba(255,255,255,0.3);
        }

        /* Matched State */
        .card-wrapper.matched .card-inner {
            opacity: 0.5;
            cursor: default;
        }
        .card-wrapper.matched .game-cover {
            background: #48bb78; /* Green tint when matched */
            border-color: #48bb78;
        }

        /* Responsive */
        @media (max-width: 600px) {
            :root {
                --card-width: 100%;
                --card-height: 180px;
                --game-card-size: 90px; /* Smaller for mobile grid */
            }
            .container { padding: 0 10px; }
            .container.game-mode { gap: 10px; }
            .container.game-mode .card-word { font-size: 0.8rem; }
            .game-info { flex-direction: row; padding: 10px; }
            .stat-value { font-size: 1.2rem; }
            .game-btn { padding: 8px 16px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>

    <header>
        <h1>üá∫üá∏ Flashcards & Game üáªüá≥</h1>
        
        <!-- Mode Switcher -->
        <div class="mode-switch">
            <button class="mode-btn active" id="btnStudy" onclick="switchMode('study')">
                <i class="fas fa-book-open"></i> H·ªçc T·ª´
            </button>
            <button class="mode-btn" id="btnGame" onclick="switchMode('game')">
                <i class="fas fa-gamepad"></i> Memory Game
            </button>
        </div>

        <p id="instructionText" style="color: #718096;">Nh·∫•n v√†o th·∫ª ƒë·ªÉ l·∫≠t ‚Ä¢ Nh·∫•n <i class="fas fa-volume-up"></i> ƒë·ªÉ nghe</p>
    </header>

    <!-- Study Controls -->
    <div class="controls" id="studyControls">
        <button class="filter-btn active" onclick="filterCards('all')">T·∫•t c·∫£</button>
        <button class="filter-btn" onclick="filterCards('housing')">Nh√† ·ªü</button>
        <button class="filter-btn" onclick="filterCards('place')">ƒê·ªãa ƒëi·ªÉm</button>
        <button class="filter-btn" onclick="filterCards('family')">Gia ƒë√¨nh</button>
    </div>

    <!-- Game Info with Timer -->
    <div class="game-info" id="gameInfo">
        <div class="game-stat">
            <span class="stat-label">Th·ªùi gian</span>
            <span class="stat-value" id="timer">00:00</span>
        </div>
        <div class="game-stat">
            <span class="stat-label">C·∫∑p ƒë√£ t√¨m</span>
            <span class="stat-value"><span id="matchesFound">0</span> / <span id="totalPairs">12</span></span>
        </div>
        <button class="game-btn" onclick="initGame()"><i class="fas fa-redo"></i> Ch∆°i l·∫°i</button>
    </div>

    <div class="container" id="cardContainer">
        <!-- Cards will be injected here -->
    </div>

    <!-- Victory Modal -->
    <div id="victoryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; flex-direction: column;">
        <div style="background: white; padding: 40px; border-radius: 20px; text-align: center; animation: popIn 0.5s; max-width: 90%;">
            <i class="fas fa-trophy" style="font-size: 5rem; color: #f6e05e; margin-bottom: 20px;"></i>
            <h2 style="color: #2d3748; margin: 0;">Ho√†n th√†nh!</h2>
            <p style="color: #718096; font-size: 1.2rem; margin: 10px 0;">Th·ªùi gian: <span id="finalTime" style="font-weight:bold; color:#2d3748">00:00</span></p>
            <button class="game-btn" onclick="closeVictory()" style="font-size: 1.2rem; padding: 10px 30px; margin-top: 20px;">Ch∆°i l·∫°i</button>
        </div>
    </div>

    <script>
        const vocabData = [
            // --- Housing Types ---
            { en: "Villa", vi: "Bi·ªát th·ª±", type: "housing", icon: "üè°" },
            { en: "Apartment Building", vi: "Chung c∆∞", type: "housing", icon: "üè¢" },
            { en: "Flat / Studio", vi: "CƒÉn h·ªô / Ph√≤ng thu", type: "housing", icon: "üõãÔ∏è" },
            { en: "Mansion", vi: "Dinh th·ª±", type: "housing", icon: "üè∞" },
            { en: "Detached House", vi: "Nh√† ƒë∆°n l·∫≠p", type: "housing", icon: "üè†" },
            { en: "Terraced House", vi: "Nh√† li·ªÅn k·ªÅ", type: "housing", icon: "üèòÔ∏è" },
            { en: "Semi-detached House", vi: "Nh√† song l·∫≠p", type: "housing", icon: "üè°" },
            { en: "Palace", vi: "Cung ƒëi·ªán", type: "housing", icon: "üïå" },
            { en: "Skyscraper", vi: "Nh√† ch·ªçc tr·ªùi", type: "housing", icon: "üèôÔ∏è" },
            { en: "Lighthouse", vi: "Ng·ªçn h·∫£i ƒëƒÉng", type: "housing", icon: "üö®" },
            { en: "Camping Tent", vi: "L·ªÅu c·∫Øm tr·∫°i", type: "housing", icon: "‚õ∫" },
            { en: "Cottage", vi: "Nh√† tranh / Nh√† ngo·∫°i √¥", type: "housing", icon: "üè°" },
            { en: "Houseboat", vi: "Nh√† thuy·ªÅn", type: "housing", icon: "üõ•Ô∏è" },
            { en: "Mobile Home", vi: "Nh√† di ƒë·ªông", type: "housing", icon: "üöê" },

            // --- Places in Town ---
            { en: "Library", vi: "Th∆∞ vi·ªán", type: "place", icon: "üìö" },
            { en: "Department Store", vi: "C·ª≠a h√†ng b√°ch h√≥a", type: "place", icon: "üõçÔ∏è" },
            { en: "Post Office", vi: "B∆∞u ƒëi·ªán", type: "place", icon: "üìÆ" },
            { en: "Pharmacy / Chemist", vi: "Hi·ªáu thu·ªëc", type: "place", icon: "üíä" },
            { en: "Sports Center / Gym", vi: "Trung t√¢m th·ªÉ thao", type: "place", icon: "üèãÔ∏è" },
            { en: "Bookstore", vi: "Hi·ªáu s√°ch", type: "place", icon: "üìñ" },
            { en: "Factory", vi: "Nh√† m√°y", type: "place", icon: "üè≠" },
            { en: "Cinema", vi: "R·∫°p chi·∫øu phim", type: "place", icon: "üé¨" },
            { en: "Bank", vi: "Ng√¢n h√†ng", type: "place", icon: "üè¶" },
            { en: "Museum", vi: "B·∫£o t√†ng", type: "place", icon: "üñºÔ∏è" },
            { en: "Stadium", vi: "S√¢n v·∫≠n ƒë·ªông", type: "place", icon: "üèüÔ∏è" },
            { en: "Station", vi: "Nh√† ga", type: "place", icon: "üöÜ" },

            // --- Family Home ---
            { en: "The heating", vi: "H·ªá th·ªëng s∆∞·ªüi", type: "family", icon: "üî•" },
            { en: "Call an engineer", vi: "G·ªçi th·ª£ s·ª≠a ch·ªØa", type: "family", icon: "üë®‚Äçüîß" },
            { en: "A brush", vi: "B√†n ch·∫£i / C√°i ch·ªïi", type: "family", icon: "üßπ" },
            { en: "Washing machine", vi: "M√°y gi·∫∑t", type: "family", icon: "üß∫" },
            { en: "Pick them up", vi: "Nh·∫∑t ch√∫ng l√™n", type: "family", icon: "ü§è" },
            { en: "Look for", vi: "T√¨m ki·∫øm", type: "family", icon: "üîç" },
            { en: "Move", vi: "Chuy·ªÉn nh√†", type: "family", icon: "üì¶" },
            { en: "Shelves", vi: "K·ªá / Gi√° ƒë·ª±ng ƒë·ªì", type: "family", icon: "üóÑÔ∏è" },
            { en: "Empty", vi: "Tr·ªëng r·ªóng", type: "family", icon: "üï≥Ô∏è" },
            { en: "Rent", vi: "Thu√™ / Ti·ªÅn thu√™", type: "family", icon: "üîë" },
            { en: "Apartment", vi: "CƒÉn h·ªô", type: "family", icon: "üè¢" },
            { en: "Furniture", vi: "ƒê·ªì n·ªôi th·∫•t", type: "family", icon: "üõãÔ∏è" },
            { en: "Keep room tidy", vi: "Gi·ªØ ph√≤ng g·ªçn g√†ng", type: "family", icon: "‚ú®" },
            { en: "Repair", vi: "S·ª≠a ch·ªØa", type: "family", icon: "üõ†Ô∏è" },
            { en: "Wash the dishes", vi: "R·ª≠a b√°t", type: "family", icon: "üçΩÔ∏è" },
            { en: "Lazy", vi: "L∆∞·ªùi bi·∫øng", type: "family", icon: "üò¥" },
            { en: "Take dog for walk", vi: "D·∫Øt ch√≥ ƒëi d·∫°o", type: "family", icon: "üêï" }
        ];

        const container = document.getElementById('cardContainer');
        const synth = window.speechSynthesis;
        let currentMode = 'study'; // 'study' or 'game'
        let currentFilter = 'all';
        let lastUsedWords = []; // Theo d√µi c√°c t·ª´ ƒë√£ d√πng

        // Stopwatch Variables
        let timerInterval;
        let seconds = 0;
        let isTimerRunning = false;

        // --- GENERAL FUNCTIONS ---

        function speak(text, event) {
            if (event) event.stopPropagation();
            if (synth.speaking) synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            synth.speak(utterance);
        }

        function switchMode(mode) {
            currentMode = mode;
            
            // UI Updates
            document.getElementById('btnStudy').className = `mode-btn ${mode === 'study' ? 'active' : ''}`;
            document.getElementById('btnGame').className = `mode-btn ${mode === 'game' ? 'active' : ''}`;
            
            const studyControls = document.getElementById('studyControls');
            const gameInfo = document.getElementById('gameInfo');
            const instruction = document.getElementById('instructionText');

            if (mode === 'study') {
                stopTimer();
                studyControls.style.display = 'flex';
                gameInfo.style.display = 'none';
                container.classList.remove('game-mode');
                instruction.innerHTML = 'Nh·∫•n v√†o th·∫ª ƒë·ªÉ l·∫≠t ‚Ä¢ Nh·∫•n <i class="fas fa-volume-up"></i> ƒë·ªÉ nghe';
                renderCards(currentFilter);
            } else {
                studyControls.style.display = 'none';
                gameInfo.style.display = 'flex';
                container.classList.add('game-mode');
                instruction.innerHTML = 'T√¨m c·∫∑p: T·ª´ Ti·∫øng Anh - Nghƒ©a Ti·∫øng Vi·ªát';
                initGame();
            }
        }

        // --- TIMER FUNCTIONS ---
        function startTimer() {
            if (isTimerRunning) return;
            isTimerRunning = true;
            seconds = 0;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                seconds++;
                updateTimerDisplay();
            }, 1000);
        }

        function stopTimer() {
            isTimerRunning = false;
            clearInterval(timerInterval);
        }

        function resetTimer() {
            stopTimer();
            seconds = 0;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('timer').innerText = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // --- STUDY MODE FUNCTIONS ---

        function renderCards(filterType) {
            container.innerHTML = '';
            currentFilter = filterType;
            
            const filteredData = filterType === 'all' 
                ? vocabData 
                : vocabData.filter(item => item.type === filterType);

            filteredData.forEach(item => {
                const cardWrapper = document.createElement('div');
                cardWrapper.className = `card-wrapper type-${item.type}`;
                
                let typeName = item.type === 'housing' ? 'Housing' : (item.type === 'family' ? 'Family Home' : 'Place');
                
                cardWrapper.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front">
                            <button class="audio-btn" title="Nghe ph√°t √¢m" onclick="speak('${item.en.replace(/'/g, "\\'")}', event)">
                                <i class="fas fa-volume-up"></i>
                            </button>
                            <div class="card-word">${item.en}</div>
                            <span class="card-tag">${typeName}</span>
                        </div>
                        <div class="card-back">
                            <div class="card-icon">${item.icon}</div>
                            <h3 class="card-meaning">${item.vi}</h3>
                        </div>
                    </div>
                `;

                cardWrapper.querySelector('.card-inner').addEventListener('click', function() {
                    cardWrapper.classList.toggle('flipped');
                });

                container.appendChild(cardWrapper);
            });
        }

        function filterCards(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderCards(type);
        }

        // --- MEMORY GAME FUNCTIONS ---

        let hasFlippedCard = false;
        let lockBoard = false;
        let firstCard, secondCard;
        let pairsMatched = 0;
        let totalPairs = 12;

        function initGame() {
            resetTimer(); // Reset timer when game initializes
            container.innerHTML = '';
            pairsMatched = 0;
            hasFlippedCard = false;
            lockBoard = false;
            
            // 1. Select vocabulary based on filter
            let sourceData = currentFilter === 'all' ? vocabData : vocabData.filter(i => i.type === currentFilter);
            
            // --- Anti-repetition Logic ---
            let freshItems = sourceData.filter(item => !lastUsedWords.includes(item.en));
            let staleItems = sourceData.filter(item => lastUsedWords.includes(item.en));

            freshItems.sort(() => 0.5 - Math.random());
            staleItems.sort(() => 0.5 - Math.random());

            let selectedItems = [];
            let needed = totalPairs;

            // Prioritize fresh items
            let takeFresh = Math.min(needed, freshItems.length);
            selectedItems = selectedItems.concat(freshItems.slice(0, takeFresh));
            needed -= takeFresh;

            // Fill with stale items if needed
            if (needed > 0) {
                let takeStale = Math.min(needed, staleItems.length);
                selectedItems = selectedItems.concat(staleItems.slice(0, takeStale));
            }

            // Update used words list
            lastUsedWords = selectedItems.map(item => item.en);
            
            document.getElementById('totalPairs').innerText = selectedItems.length;
            document.getElementById('matchesFound').innerText = '0';

            // 2. Create Pairs
            let gameCards = [];
            selectedItems.forEach((item, index) => {
                // English Card
                gameCards.push({
                    id: index, // Unique Pair ID
                    type: item.type,
                    content: `<div class="card-word">${item.en}</div>`,
                    isEnglish: true
                });
                // Vietnamese Card
                gameCards.push({
                    id: index, // Matching Pair ID
                    type: item.type,
                    content: `<div class="card-icon">${item.icon}</div><div class="card-meaning">${item.vi}</div>`,
                    isEnglish: false
                });
            });

            // 3. Shuffle Game Cards
            gameCards.sort(() => 0.5 - Math.random());

            // 4. Render
            gameCards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = `card-wrapper type-${card.type}`;
                cardEl.dataset.id = card.id; // Store ID in dataset for matching logic

                cardEl.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front game-cover">
                            <i class="fas fa-question"></i>
                        </div>
                        <div class="card-back">
                            ${card.content}
                        </div>
                    </div>
                `;

                cardEl.addEventListener('click', flipGameCard);
                container.appendChild(cardEl);
            });
        }

        function flipGameCard() {
            // Start timer on first valid click
            if (!isTimerRunning && pairsMatched < totalPairs) {
                startTimer();
            }

            if (lockBoard) return;
            if (this === firstCard) return; // Prevent double clicking same card
            if (this.classList.contains('matched')) return; // Prevent clicking matched cards

            this.classList.add('flipped');

            if (!hasFlippedCard) {
                // First click
                hasFlippedCard = true;
                firstCard = this;
                return;
            }

            // Second click
            secondCard = this;
            lockBoard = true; // Lock the board immediately upon 2nd click
            checkForMatch();
        }

        function checkForMatch() {
            // Check if datasets match
            let isMatch = firstCard.dataset.id === secondCard.dataset.id;

            if (isMatch) {
                disableCards();
            } else {
                unflipCards();
            }
        }

        function disableCards() {
            firstCard.removeEventListener('click', flipGameCard);
            secondCard.removeEventListener('click', flipGameCard);
            
            // Delay adding matched style for visual clarity
            setTimeout(() => {
                firstCard.classList.add('matched');
                secondCard.classList.add('matched');
                resetBoard();
            }, 500);

            pairsMatched++;
            document.getElementById('matchesFound').innerText = pairsMatched;

            let targetPairs = parseInt(document.getElementById('totalPairs').innerText);
            if (pairsMatched === targetPairs) {
                stopTimer(); // <-- D·ª´ng ƒë·ªìng h·ªì ngay l·∫≠p t·ª©c khi ho√†n th√†nh
                setTimeout(() => {
                    document.getElementById('finalTime').innerText = document.getElementById('timer').innerText;
                    document.getElementById('victoryModal').style.display = 'flex';
                }, 800);
            }
        }

        function unflipCards() {
            lockBoard = true;
            
            // Add shake animation for wrong guess
            setTimeout(() => {
                firstCard.classList.add('wrong');
                secondCard.classList.add('wrong');
            }, 400);

            setTimeout(() => {
                firstCard.classList.remove('flipped', 'wrong');
                secondCard.classList.remove('flipped', 'wrong');
                resetBoard();
            }, 1200);
        }

        function resetBoard() {
            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
        }

        function closeVictory() {
            document.getElementById('victoryModal').style.display = 'none';
            initGame();
        }

        // Initial render
        renderCards('all');

    </script>
</body>
</html>
